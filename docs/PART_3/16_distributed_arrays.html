<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.313">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Programação Paralela em Julia: uma História com Suricates - 16&nbsp; DistributedArray</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../PART_3/17_pipeline.html" rel="next">
<link href="../PART_3/15_shared_arrays.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>


</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Programação Paralela em Julia: uma História com Suricates</span>
    </a>
  </div>
          <div class="quarto-toggle-container ms-auto">
              <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
          </div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title"><code>DistributedArray</code></span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link"><strong>Bem-vindo</strong></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../PART_1/00_intro_story.html" class="sidebar-item-text sidebar-link">Part 1 - A Caçada</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../PART_1/01_for_if.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title"><code>for</code> and <code>if</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../PART_1/02_function.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title"><code>function</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../PART_1/03_map.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title"><code>map</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../PART_1/04_inline.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Inplace Operations</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../PART_1/05_named_tuples.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Tuplas Nomeadas</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../PART_2/00_going_travelling.html" class="sidebar-item-text sidebar-link">Part 2 - Os Mapas</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../PART_2/06_edge_detection.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Detecção de Bordas</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../PART_2/07_at_threads.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title"><code>Threads.@threads</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../PART_2/08_at_spawn.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title"><code>Threads.@spawn</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../PART_2/09_spatial_divison.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Divisão Espacial</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../PART_2/10_threadsx.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title"><code>ThreadsX</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../PART_2/11_parallel_stencil.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title"><code>ParallelStencil</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../PART_2/12_benchmarks.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Benchmarks</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../PART_3/00_going_for_work.html" class="sidebar-item-text sidebar-link">Part 3 - Ao Trabalho</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../PART_3/13_pmap.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title"><code>pmap</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../PART_3/14_at_spawnat.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title"><code>@spawnat</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../PART_3/15_shared_arrays.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title"><code>SharedArrays</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../PART_3/16_distributed_arrays.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title"><code>DistributedArray</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../PART_3/17_pipeline.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title"><code>pipeline</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../PART_3/18_spmd.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title"><code>SPMD</code></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
   
  <ul>
  <li><a href="#novos-índices" id="toc-novos-índices" class="nav-link active" data-scroll-target="#novos-índices"><span class="toc-section-number">16.1</span>  Novos índices</a></li>
  <li><a href="#novos-tunéis" id="toc-novos-tunéis" class="nav-link" data-scroll-target="#novos-tunéis"><span class="toc-section-number">16.2</span>  Novos tunéis</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title"><code>DistributedArray</code></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>Uma semana depois do incidente com o terreno rochoso, Jessie, até então chefe de Daisy, é demitida, pois ela foi denunciada na Organização Internacional do Trabalho (OIT) devido aos seus abusos no ambiente de trabalho. Afinal de contas, não é porque um suricate trabalha com escavação que ele precisa ser sobrecarregado de tarefas.</p>
<p>Como resultado, um novo chefe foi apresentado, <code>Fuli</code>, um gerente com anos de experiência em escavação de todos os tipos. Fuli pretende garantir uma distribuição igual de tarefas entre os suricates. Ele deseja implementar uma nova regra pela qual cada suricate só pode acessar seu próprio local de escavação, aumentando assim o foco no trabalho.</p>
<section id="novos-índices" class="level2" data-number="16.1">
<h2 data-number="16.1" class="anchored" data-anchor-id="novos-índices"><span class="header-section-number">16.1</span> Novos índices</h2>
<p>Fuli também tem experiência com programação, e informa Daisy que seus códigos apesar de bem intencionados, nunca funcionariam na linha de produção, pois <code>SharedArrays.jl</code> é uma solução para <em>emular</em> processos distribuidos, mas exige que os dados sejam compartilhados, ou seja, suas matrizes <em>precisam</em> estar no mesmo computador.</p>
<p>Caso Daisy queira rodar seus códigos em paralelo de verdade, ela precisa usar o pacote <code>DistributedArrays.jl</code>. Esse pacote facilita a distribuição dos indices de cada trabalhador, mas precisa de um pouco de atenção para acessar os dados corretamente.</p>
<p><img src="darrays_pt.png" class="img-fluid"></p>
<p>Daisy ficou confusa, mas Fuli lhe deu alguns exemplos básicos. Fuli explica que é necessário criar variáveis distribuidas, do mesmo jeito que Daisy criou uma matriz preenchida com zeros, usando a função <code>zeros</code>, o pacote <code>DistributedArrays.jl</code> disponibiliza alguns comandos semelhantes, mas com um <code>d</code> adicional, tal como <code>dzeros</code>, <code>dones</code>.</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1"></a><span class="im">using</span> <span class="bu">Distributed</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="fu">addprocs</span>(<span class="fl">2</span>)</span>
<span id="cb1-3"><a href="#cb1-3"></a></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="pp">@everywhere</span> <span class="im">using</span> <span class="bu">DistributedArrays</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>exemplo <span class="op">=</span> <span class="fu">dzeros</span>(<span class="dt">Int64</span>, <span class="fl">3</span>, <span class="fl">6</span>)</span>
<span id="cb1-6"><a href="#cb1-6"></a></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="pp">@everywhere</span> <span class="kw">function</span> <span class="fu">ver_indices_globais</span>(exemplo)</span>
<span id="cb1-8"><a href="#cb1-8"></a>    Δx, Δy <span class="op">=</span> DistributedArrays.<span class="fu">localindices</span>(exemplo)</span>
<span id="cb1-9"><a href="#cb1-9"></a>    <span class="fu">println</span>(<span class="st">"índices Globais: Δx = </span><span class="sc">$</span>(Δx)<span class="st">, Δy = </span><span class="sc">$</span>(Δy)<span class="st">"</span>)</span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="kw">end</span></span>
<span id="cb1-11"><a href="#cb1-11"></a></span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="cf">for</span> w <span class="kw">in</span> <span class="fu">workers</span>()</span>
<span id="cb1-13"><a href="#cb1-13"></a>    <span class="pp">@spawnat</span> w <span class="fu">ver_indices_globais</span>(exemplo)</span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="cf">end</span></span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="fu">sleep</span>(<span class="fl">1</span>) <span class="co"># para dar tempo da mensagem aparecer</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      From worker 2:    índices Globais: Δx = 1:3, Δy = 1:3
      From worker 3:    índices Globais: Δx = 1:3, Δy = 4:6</code></pre>
</div>
</div>
<div class="callout-tip callout callout-style-simple callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Sintaxe: <code>distribute</code>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Caso você deseje criar uma matriz no localmente, e depois distribui-lá, é só usar o comando <code>disitrubte(matriz)</code></p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3" data-code-line-numbers="false"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># encontra o primeiro valor '4'</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> [<span class="fl">1</span> <span class="fl">0</span> <span class="fl">0</span>; <span class="fl">2</span> <span class="fl">0</span> <span class="fl">0</span>; <span class="fl">3</span> <span class="fl">0</span> <span class="fl">0</span>]</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>dA <span class="op">=</span> <span class="fu">distribute</span>(A)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>3×3 DArray{Int64, 2, Matrix{Int64}}:
 1  0  0
 2  0  0
 3  0  0</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Uma vez que Daisy conhece os índices globais, os índices locais são iguais aos comprimento de cada intervalo. Fuli alerta Daisy, para escrever em matrizes distribuidas, só podem ser utilizados indices locais, e além disso, com uma palavra chave especial, <code>localpart</code>, então Daisy deveria ter cuidado, e não confundir o <code>parte_local</code> que ela já havia criado anteriormente - talvez uma mudança de nome de variáveis seriam bem vindas, Daisy precisaria falar com seu mestre.</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1"></a><span class="pp">@everywhere</span> <span class="kw">function</span> <span class="fu">escrever_indice_local!</span>(exemplo)</span>
<span id="cb5-2"><a href="#cb5-2"></a>    Δx, Δy <span class="op">=</span> DistributedArrays.<span class="fu">localindices</span>(exemplo)</span>
<span id="cb5-3"><a href="#cb5-3"></a>    indice_local_x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu">length</span>(Δx)</span>
<span id="cb5-4"><a href="#cb5-4"></a>    indice_local_y <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu">length</span>(Δy)</span>
<span id="cb5-5"><a href="#cb5-5"></a></span>
<span id="cb5-6"><a href="#cb5-6"></a>    <span class="cf">for</span> x <span class="kw">in</span> indice_local_x, y <span class="kw">in</span> indice_local_y</span>
<span id="cb5-7"><a href="#cb5-7"></a>        <span class="fu">localpart</span>(exemplo)[x, y] <span class="op">=</span> <span class="fu">myid</span>()</span>
<span id="cb5-8"><a href="#cb5-8"></a>    <span class="cf">end</span></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="kw">end</span></span>
<span id="cb5-10"><a href="#cb5-10"></a>exemplo <span class="op">=</span> <span class="fu">dzeros</span>(<span class="dt">Int64</span>, <span class="fl">3</span>, <span class="fl">6</span>)</span>
<span id="cb5-11"><a href="#cb5-11"></a><span class="cf">for</span> w <span class="kw">in</span> <span class="fu">workers</span>()</span>
<span id="cb5-12"><a href="#cb5-12"></a>    <span class="pp">@spawnat</span> w <span class="fu">escrever_indice_local!</span>(exemplo)</span>
<span id="cb5-13"><a href="#cb5-13"></a><span class="cf">end</span></span>
<span id="cb5-14"><a href="#cb5-14"></a><span class="fu">display</span>(exemplo);</span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="fu">rmprocs</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>3×6 DArray{Int64, 2, Matrix{Int64}}:
 2  2  2  3  3  3
 2  2  2  3  3  3
 2  2  2  3  3  3</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>Task (done) @0x00007f8377af1c30</code></pre>
</div>
</div>
</section>
<section id="novos-tunéis" class="level2" data-number="16.2">
<h2 data-number="16.2" class="anchored" data-anchor-id="novos-tunéis"><span class="header-section-number">16.2</span> Novos tunéis</h2>
<p>Daisy fez muitos erros, mas finalmente conseguiu, ela adpatou seu código antigo para utilizar o pacote <code>DistributedArrays.jl</code>. Depois de tantos bugs, Daisy chegou a conclusão que é melhor fazer tratamentos de erro, já que quando bugs acontecem em processos remotos, eles não são redirecionados ao processo central, logo, não existem mensagens de erro na tela.</p>
<div class="callout-tip callout callout-style-simple callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Sintaxe: <code>try</code>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Um bloco <code>try-catch</code> funciona como esperado de outras linguagens de programação, sua utilização básica consiste em apenas colocar o seu código dentro do bloco <code>try</code>.</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8" data-code-line-numbers="false"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>try</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sqrt</span>(<span class="op">-</span><span class="fl">1</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>catch</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"Não é possível fazer sqrt(-1)"</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"Tente sqrt(Complex(-1))"</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Não é possível fazer sqrt(-1)
Tente sqrt(Complex(-1))</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1"></a><span class="im">using</span> <span class="bu">Distributed</span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="fu">addprocs</span>(<span class="fl">3</span>)</span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="pp">@everywhere</span> <span class="im">using</span> <span class="bu">DistributedArrays</span></span>
<span id="cb10-4"><a href="#cb10-4"></a></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="pp">@everywhere</span> <span class="kw">function</span> <span class="fu">d_escavar_tunel!</span>(terreno)</span>
<span id="cb10-6"><a href="#cb10-6"></a>    try</span>
<span id="cb10-7"><a href="#cb10-7"></a>        Δx, Δy <span class="op">=</span> DistributedArrays.<span class="fu">localindices</span>(terreno)</span>
<span id="cb10-8"><a href="#cb10-8"></a></span>
<span id="cb10-9"><a href="#cb10-9"></a>        qtd_camadas <span class="op">=</span> <span class="fu">length</span>(Δx)</span>
<span id="cb10-10"><a href="#cb10-10"></a>        tamanho_região <span class="op">=</span> <span class="fu">length</span>(Δy)</span>
<span id="cb10-11"><a href="#cb10-11"></a></span>
<span id="cb10-12"><a href="#cb10-12"></a>        <span class="co"># primeira linha é a linha do solo</span></span>
<span id="cb10-13"><a href="#cb10-13"></a>        ponto_partida <span class="op">=</span> <span class="fu">rand</span>(<span class="fl">1</span><span class="op">:</span>tamanho_região)</span>
<span id="cb10-14"><a href="#cb10-14"></a></span>
<span id="cb10-15"><a href="#cb10-15"></a>        <span class="co"># '1' == escavar a posição</span></span>
<span id="cb10-16"><a href="#cb10-16"></a>        escavar <span class="op">=</span> <span class="fu">one</span>(<span class="fu">eltype</span>(terreno))</span>
<span id="cb10-17"><a href="#cb10-17"></a>        <span class="fu">localpart</span>(terreno)[<span class="fl">1</span>, ponto_partida] <span class="op">=</span> escavar</span>
<span id="cb10-18"><a href="#cb10-18"></a></span>
<span id="cb10-19"><a href="#cb10-19"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span>qtd_camadas</span>
<span id="cb10-20"><a href="#cb10-20"></a>            ulitma_camada <span class="op">=</span> <span class="fu">localpart</span>(terreno)[i<span class="op">-</span><span class="fl">1</span>, <span class="op">:</span>]</span>
<span id="cb10-21"><a href="#cb10-21"></a></span>
<span id="cb10-22"><a href="#cb10-22"></a>            <span class="co"># garante que o código funcione para outros</span></span>
<span id="cb10-23"><a href="#cb10-23"></a>            <span class="co"># tipos de matrizes, lém de matriz</span></span>
<span id="cb10-24"><a href="#cb10-24"></a>            <span class="co"># com `true`/`false`</span></span>
<span id="cb10-25"><a href="#cb10-25"></a>            ultima_posicao <span class="op">=</span> <span class="fu">findfirst</span>(</span>
<span id="cb10-26"><a href="#cb10-26"></a>                ulitma_camada <span class="op">.==</span> escavar</span>
<span id="cb10-27"><a href="#cb10-27"></a>                )</span>
<span id="cb10-28"><a href="#cb10-28"></a></span>
<span id="cb10-29"><a href="#cb10-29"></a>            esquerda <span class="op">=</span> ultima_posicao <span class="op">-</span> <span class="fl">1</span></span>
<span id="cb10-30"><a href="#cb10-30"></a>            meio <span class="op">=</span> ultima_posicao</span>
<span id="cb10-31"><a href="#cb10-31"></a>            direita <span class="op">=</span> ultima_posicao <span class="op">+</span> <span class="fl">1</span></span>
<span id="cb10-32"><a href="#cb10-32"></a></span>
<span id="cb10-33"><a href="#cb10-33"></a>            <span class="cf">if</span> esquerda <span class="op">&lt;</span> <span class="fl">1</span></span>
<span id="cb10-34"><a href="#cb10-34"></a>                possiveis_posições <span class="op">=</span> [direita,</span>
<span id="cb10-35"><a href="#cb10-35"></a>                                    meio]</span>
<span id="cb10-36"><a href="#cb10-36"></a>            <span class="cf">elseif</span> direita <span class="op">&gt;</span> tamanho_região</span>
<span id="cb10-37"><a href="#cb10-37"></a>                possiveis_posições <span class="op">=</span> [meio,</span>
<span id="cb10-38"><a href="#cb10-38"></a>                                    esquerda]</span>
<span id="cb10-39"><a href="#cb10-39"></a>            <span class="cf">else</span></span>
<span id="cb10-40"><a href="#cb10-40"></a>                possiveis_posições <span class="op">=</span> [esquerda,</span>
<span id="cb10-41"><a href="#cb10-41"></a>                                    meio,</span>
<span id="cb10-42"><a href="#cb10-42"></a>                                    direita]</span>
<span id="cb10-43"><a href="#cb10-43"></a>            <span class="cf">end</span></span>
<span id="cb10-44"><a href="#cb10-44"></a></span>
<span id="cb10-45"><a href="#cb10-45"></a>            aonde_escavar <span class="op">=</span> <span class="fu">rand</span>(possiveis_posições)</span>
<span id="cb10-46"><a href="#cb10-46"></a>            <span class="fu">localpart</span>(terreno)[i, aonde_escavar] <span class="op">=</span> escavar</span>
<span id="cb10-47"><a href="#cb10-47"></a>        <span class="cf">end</span></span>
<span id="cb10-48"><a href="#cb10-48"></a>    catch</span>
<span id="cb10-49"><a href="#cb10-49"></a>        <span class="fu">println</span>(<span class="st">"Aconteceu um Erro."</span>)</span>
<span id="cb10-50"><a href="#cb10-50"></a>    <span class="kw">end</span></span>
<span id="cb10-51"><a href="#cb10-51"></a></span>
<span id="cb10-52"><a href="#cb10-52"></a>   <span class="cf">return</span> <span class="cn">nothing</span></span>
<span id="cb10-53"><a href="#cb10-53"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A construção da matriz distribuída também requer um cuidado adicional, pois é possível controlar quais suricates vão participar da construção do túnel, e em quantas partes cada dimensão da matriz será particionada.</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb11-1"><a href="#cb11-1"></a><span class="co">## Preciso passar uma tupla com as dimensões da matriz</span></span>
<span id="cb11-2"><a href="#cb11-2"></a>dimensões_terreno <span class="op">=</span> (<span class="fl">10</span>, <span class="fl">6</span>)</span>
<span id="cb11-3"><a href="#cb11-3"></a></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="co">## Um vetor com os processos que farão o trabalho</span></span>
<span id="cb11-5"><a href="#cb11-5"></a>escavadores <span class="op">=</span> <span class="fu">workers</span>()</span>
<span id="cb11-6"><a href="#cb11-6"></a></span>
<span id="cb11-7"><a href="#cb11-7"></a><span class="co"># Cada componente do vetor, corresponde a qtd</span></span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="co"># de particições em cada dimensão. Por exemplo</span></span>
<span id="cb11-9"><a href="#cb11-9"></a><span class="co"># ['1', 2] = eixo 1 não tem divisão</span></span>
<span id="cb11-10"><a href="#cb11-10"></a><span class="co"># [1, '3'] = eixo 2 é divido em 3 partes</span></span>
<span id="cb11-11"><a href="#cb11-11"></a>divisões <span class="op">=</span> [<span class="fl">1</span>, <span class="fl">3</span>]</span>
<span id="cb11-12"><a href="#cb11-12"></a></span>
<span id="cb11-13"><a href="#cb11-13"></a><span class="co"># não tem função que cria matriz booleana,</span></span>
<span id="cb11-14"><a href="#cb11-14"></a><span class="co"># então preciso usar a função `dfill`</span></span>
<span id="cb11-15"><a href="#cb11-15"></a>terreno <span class="op">=</span> <span class="fu">dfill</span>(<span class="cn">false</span>, dimensões_terreno, escavadores, divisões)</span>
<span id="cb11-16"><a href="#cb11-16"></a></span>
<span id="cb11-17"><a href="#cb11-17"></a><span class="cf">for</span> w <span class="kw">in</span> <span class="fu">workers</span>()</span>
<span id="cb11-18"><a href="#cb11-18"></a>    <span class="pp">@spawnat</span> w <span class="fu">d_escavar_tunel!</span>(terreno)</span>
<span id="cb11-19"><a href="#cb11-19"></a><span class="cf">end</span></span>
<span id="cb11-20"><a href="#cb11-20"></a></span>
<span id="cb11-21"><a href="#cb11-21"></a><span class="im">using</span> <span class="bu">SparseArrays</span></span>
<span id="cb11-22"><a href="#cb11-22"></a><span class="fu">sparse</span>(terreno)</span>
<span id="cb11-23"><a href="#cb11-23"></a></span>
<span id="cb11-24"><a href="#cb11-24"></a><span class="fu">rmprocs</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../PART_3/15_shared_arrays.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title"><code>SharedArrays</code></span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../PART_3/17_pipeline.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title"><code>pipeline</code></span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
      <div class="nav-footer-center">2023</div>
  </div>
</footer>



<script src="../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>